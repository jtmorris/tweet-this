<!DOCTYPE html>
<html>
	<head>
		<title>Create "Tweet This" Shortcode</title>
		<!-- Disable browser caching of dialog window -->
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="pragma" content="no-cache" />

		<link rel="stylesheet" href="../assets/css/jquery/cupertino-theme/jquery-ui.min.css" />
		<style type='text/css'>
			#TT_tinymce_dialog {
				font-family: "Open Sans", sans-serif;
				font-size: 13px;
			}
			table.form-table {
				width: 100%;
			}
			table.form-table th {
				vertical-align: top;
				width: 150px;
			}
			table.form-table td,
			table.form-table th {
				padding: 10px 0;
			}
			#TT_tinymce_dialog_text {
				height: 45px;
				font-family: "Open Sans", sans-serif;
			}
			input,
			textarea {
				width: 95%;

				font-size: 16px;

				padding: 3px;
			}
			input:disabled {
				background-color: #BBB;
			}
			input[type="checkbox"],
			input[type="radio"] {
				width: auto;
			}
			input[type="submit"] {
				width: auto;

				background-color: #3399FF;
				box-shadow: 2px 2px 3px 0 #444;

				padding: 8px;

				border: none;
				border-radius: 4px;

				margin-top: 5px;
				float: right;
			}
			input[type="submit"]:hover {
				background-color: #33CC33;
				cursor: pointer;
			}
			p.tt_admin_help_text {
				color: #555;
				font-size: .9em;
				font-style: italic;
			}
			span.tt_admin_example {
				color: #38f;
				font-style: normal;
				margin: 0 5px;
			}
			#TT_tinymce_tweet_preview {
				font-size: 24px;
				font-weight: 200;

				background-color: #CCC;

				width: 95%;
				height: 100px;
			}
			#TT_accordion h3 {
				font-size: 18px;
				padding-top: 3px;
				padding-bottom: 3px;
			}
			div.TT_tinymce_preview_warning {
				color: #666;
				font-size: .93em;
				margin-bottom: 10px;

				padding: 10px;

				background-color: #FFFBC9;
				border: 1px solid #730000;
				border-radius: 8px;
			}
		</style>
	</head>
	<body>
		<div id='TT_tinymce_dialog'>
			<form>
				<div class='TT_accordion'>
					<h3>Content</h3>
					<div id='TT_section_content'>
						<table class='form-table'>
							<tr>
								<th scope="row">Text To Tweet</th>
								<td>
									<textarea id="TT_tinymce_dialog_text"></textarea>
								</td>
							</tr>
						</table>
					</div>
				</div>
				<div class='TT_accordion'>
					<h3>Twitter Handles Options</h3>
					<div id='TT_section_handles'>
						<table class='form-table'>
							<tr>
								<th scope="row">Override Twitter Handles</th>
								<td>
									<input id="TT_tinymce_dialog_twitter_handle_override" type="text" />
									<p class='tt_admin_help_text'>
										Comma seperated list of "via" Twitter handles you want
										added to your tweets.
										<br />
										Example: <span class="tt_admin_example">@jt_morris, @DTELinux, @CraigyFerg</span>
									</p>
								</td>
							</tr>
							<tr>
								<th scope="row">Remove Twitter Handles</th>
								<td>
									<input id="TT_tinymce_dialog_remove_twitter_handles" type="checkbox" />
									<p class='tt_admin_help_text'>
										Check this to remove Twitter handles from the tweet.
									</p>
								</td>
							</tr>
						</table>
					</div>
				</div>
				<div class='TT_accordion'>
					<h3>Post URL Options</h3>
					<div id='TT_section_post_url'>
						<table class='form-table'>
							<tr>
								<th scope="row">Override Post URL</th>
								<td>
									<input id="TT_tinymce_dialog_url_override" type="url" />
									<p class="tt_admin_help_text">
										The link to include with your tweets.
									</p>
								</td>
							</tr>
							<tr>
								<th scope="row">Remove Post URL</th>
								<td>
									<input id="TT_tinymce_dialog_remove_url" type="checkbox" />
									<p class='tt_admin_help_text'>
										Check this to remove the post URL from the tweet.
									</p>
								</td>
							</tr>
						</table>
					</div>
				</div>
				<div class='TT_accordion'>
					<h3>Hidden Content Options</h3>
					<div id='TT_section_hidden'>
						<table class='form-table'>
							
							<tr>
								<th scope="row">Override Hidden Hashtags</th>
								<td>
									<input id="TT_tinymce_dialog_hidden_hashtags_override" type="text" />
									<p class="tt_admin_help_text">
										Hashtags you want included in the tweet when the user tweets your message, but
										hidden in the Tweet This box your site visitors see.
										<br />
										Example: <span class="tt_admin_example">#hashtags #rule</span>
									</p>
								</td>
							</tr>
							
							<tr>
								<th scope="row">Remove Hidden Hashtags</th>
								<td>
									<input id="TT_tinymce_dialog_remove_hidden_hashtags" type="checkbox" />
									<p class='tt_admin_help_text'>
										Check this to remove any default hidden hashtags from the tweet.
									</p>
								</td>
							</tr>
							<tr>
								<th scope="row">Override Hidden URLs</th>
								<td>
									<input id="TT_tinymce_dialog_hidden_urls_override" type="text" />
									<p class="tt_admin_help_text">
										URLs you want included in the tweet when the user tweets your message, but
										hidden in the Tweet This box your site visitors see.
										<br />
										Example: <span class="tt_admin_example">http://cs.johnmorris.me, http://eng.johnmorris.me</span>
									</p>
								</td>
							</tr>

							<tr>
								<th scope="row">Remove Hidden URLs</th>
								<td>
									<input id="TT_tinymce_dialog_remove_hidden_urls" type="checkbox" />
									<p class='tt_admin_help_text'>
										Check this to remove any default hidden URLs from the tweet.
									</p>
								</td>
							</tr>
						</table>
					</div>
				</div>
				<input type='submit' value='Insert Shortcode' />
			</form>
			<br /><br />
			<h3 id="TT_preview_heading">Preview</h3>
			<div id="TT_tinymce_preview_warning_placeholder_url" class="TT_tinymce_preview_warning" style="display: none; ">
				WordPress hasn't generated a shortlink yet. A
				placeholder of similar appearance and length has been included in
				the preview. As soon as one is generated, the correct shortlink
				will take its place. <a href="http://tweetthis.jtmorris.net/posts/scary-shortlink-warnings/" target="_blank">(Click Here For More
				Info.)</a>
			</div>
			<div id="TT_tinymce_preview_warning_validation_errors" class="TT_tinymce_preview_warning" style="display: none; ">
				Uh oh.  Something isn't right.  Double check your URL!
			</div>
			<div id="TT_tinymce_character_count">&nbsp;</div>
			<textarea readonly="readonly" id="TT_tinymce_tweet_preview"></textarea>
		</div>

		<script type='text/javascript'>
			(function() {
				//	Get the args... Sometimes this fails.
				var args = get_tinymce_params();

				if( !args ) {
					return;
				}

				//	Get jQuery
				//	http://jtmorris.net/?p=1109 for more info
				var $ = args['jquery'];

				//	Get the context for jQuery
				//	http://jtmorris.net/?p=1109 for more info
				var context = document.getElementsByTagName("body")[0];

				//	Get passed arguments
				var post_url = args['post_url'];
				var post_url_is_placeholder = args['post_url_is_placeholder'];
				var default_twitter_handles = args['default_twitter_handles'];
				var default_hidden_hashtags = args['default_hidden_hashtags'];
				var default_hidden_urls = args['default_hidden_urls'];
				var editor = args['editor'];
				
				var disable_preview = args['disable_preview'];
				var disable_handles = args['disable_handles'];
				var disable_post_url = args['disable_post_url'];
				var disable_hidden = args['disable_hidden'];
				var disable_char_count = args['disable_char_count'];

				//	Vars for readability
				var sections = {
					'general': $('#TT_section_general', context),
					'handles': $('#TT_section_handles', context),
					'post_url': $('#TT_section_post_url', context),
					'hidden': $('#TT_section_hidden', context),
				};
				var inputs = {
					'text': $('#TT_tinymce_dialog_text', context),
					'url': $('#TT_tinymce_dialog_url_override', context),
					'twitter_handles': $('#TT_tinymce_dialog_twitter_handle_override', context),
					'hidden_hashtags': $('#TT_tinymce_dialog_hidden_hashtags_override', context),
					'hidden_urls': $('#TT_tinymce_dialog_hidden_urls_override', context),
					'remove_twitter_handles': $('#TT_tinymce_dialog_remove_twitter_handles', context),
					'remove_url': $('#TT_tinymce_dialog_remove_url', context),
					'remove_hidden_hashtags': $('#TT_tinymce_dialog_remove_hidden_hashtags', context),
					'remove_hidden_urls': $('#TT_tinymce_dialog_remove_hidden_urls', context)
				};
				var form = $('#TT_tinymce_dialog form', context);
				var preview = $('#TT_tinymce_tweet_preview', context);
				var preview_heading = $('#TT_preview_heading', context);
				var characters = $('#TT_tinymce_character_count', context);
				var placeholder_url_warning = $('#TT_tinymce_preview_warning_placeholder_url', context);
				var accordionSections = $('.TT_accordion', context);


				//	Load defaults into preview
				preview.val(tt_preview_string());

				//	Display any caveats or warning about the preview
				if ( post_url_is_placeholder && !disable_preview ) {
					placeholder_url_warning.show();
				}



				//	Setup the layout of the dialog
				if( disable_preview ) {
					preview.hide();
					preview_heading.hide();
				}

				if( disable_char_count ) {
					characters.hide();
				}
				
				if( disable_handles ) {
					sections.handles.parent('.TT_accordion').remove();
				}

				if( disable_post_url ) {
					sections.post_url.parent('.TT_accordion').remove();
				}

				if( disable_hidden ) {
					sections.hidden.parent('.TT_accordion').remove();
				}




				//	Accordion the sections
				//	We have multiple accordions for each section because when
				//	submitting the form, we want to be able to expand ALL accordion
				//	sections do validation errors are visible.  Therefore,
				//	each section is an accordion with only one entry.  It looks
				//	the same, but allows multiple open sections.
				accordionSections.accordion({
					active: false,
					collapsible: true,
					heightStyle: 'content'
				});
				//	Open the general content accordion
				accordionSections.first().accordion("option", "active", 0);



				//	On text change, update preview
				inputs['text'].on('change keyup paste', function() {
					preview.val(tt_preview_string()).change();
				});

				//	On URL change, update preview and hide any URL warnings
				inputs['url'].on('change keyup paste', function() {
					preview.val(tt_preview_string()).change();

					if( inputs['url'].val() === post_url && post_url_is_placeholder ) {
						placeholder_url_warning.show();
					}
					else {
						placeholder_url_warning.hide();
					}
				});

				//	On Twitter handles change, update preview
				inputs['twitter_handles'].on('change keyup paste', function() {
					preview.val(tt_preview_string()).change();
				});

				//	On hidden hashtags change, update preview
				inputs['hidden_hashtags'].on('change keyup paste', function() {
					preview.val(tt_preview_string()).change();
				});

				//	On hidden URLS change, update preview
				inputs['hidden_urls'].on('change keyup paste', function() {
					preview.val(tt_preview_string()).change();
				});

				//	On remove checkbox changes, update preview
				inputs['remove_twitter_handles'].on('change keyup paste', function() {
					preview.val(tt_preview_string()).change();

					//	Also, disable the override fields for good measure
					if( inputs['remove_twitter_handles'].prop('checked') ) {
						inputs['twitter_handles'].prop('disabled', true);
					}
					else {
						inputs['twitter_handles'].prop('disabled', false);
					}
				});
				inputs['remove_url'].on('change keyup paste', function() {
					preview.val(tt_preview_string()).change();

					//	Also, disable the override fields for good measure
					if( inputs['remove_url'].prop('checked') ) {
						inputs['url'].prop('disabled', true);
					}
					else {
						inputs['url'].prop('disabled', false);
					}
				});
				inputs['remove_hidden_hashtags'].on('change keyup paste', function() {
					preview.val(tt_preview_string()).change();

					//	Also, disable the hidden hashtags box for good measure
					if( inputs['remove_hidden_hashtags'].prop('checked') ) {
						inputs['hidden_hashtags'].prop('disabled', true);
					}
					else {
						inputs['hidden_hashtags'].prop('disabled', false);
					}
				});
				inputs['remove_hidden_urls'].on('change keyup paste', function() {
					preview.val(tt_preview_string()).change();

					//	Also, disable the hidden hashtags box for good measure
					if( inputs['remove_hidden_urls'].prop('checked') ) {
						inputs['hidden_urls'].prop('disabled', true);
					}
					else {
						inputs['hidden_urls'].prop('disabled', false);
					}
				});


				//	Character counter and preview truncate
				preview.on('change', function() {
					//	Counter
					var count = $(this).val().length;
					if (count > 140) {
						var wrap = '<span style="color: red; font-size: 1.3em; ">';

						//	Too long, truncate the preview
						tt_truncate_preview();
					}
					else if (count >= 130) {
						var wrap = '<span style="color: red;">';
						var warning = '';
					}
					else if (count >= 120) {
						var wrap = '<span style="color: darkred;">';
						var warning = '';
					}
					else {
						var wrap = '<span>'
						var warning = '';
					}
					characters.html(wrap + (140-count) + '</span> characters left ' + warning);
				});



				//	When submit button is clicked, expand all accordions so any
				//	HTML5 validation errors are visible.
				$('input[type="submit"]').click(function() {
					accordionSections.accordion("option", "active", 0);
				});

				//	Insert the shortcode when submitted
				form.submit(function(event) {
					event.preventDefault();


					var shortcode = '[tweetthis';

					//	Do we have any handle, hashtag, or URL overrides?
					//	If so, add on parameters for them.
					if( get_clean_twitter_handles() ) {
						shortcode += ' twitter_handles="' + (get_clean_twitter_handles()) + '"';
					}
					if( get_clean_hidden_hashtags(true) ) {
						shortcode += ' hidden_hashtags="' + (get_clean_hidden_hashtags()) + '"';
					}
					if( get_clean_url() ) {
						shortcode += ' url="' + (get_clean_url()) + '"';
					}
					if( get_clean_hidden_urls(true) ) {
						shortcode += ' hidden_urls="' + (get_clean_hidden_urls()) + '"';
					}

					//	Are we supposed to remove anything from this particular tweet?
					var remove_twits           = inputs['remove_twitter_handles'].prop('checked');
					var remove_url             = inputs['remove_url'].prop('checked');
					var remove_hidden_hashtags = inputs['remove_hidden_hashtags'].prop('checked');
					var remove_hidden_urls     = inputs['remove_hidden_urls'].prop('checked');

					if( remove_twits ) {
						shortcode += ' remove_twitter_handles="true"';
					}
					if( remove_url ) {
						shortcode += ' remove_url="true"';
					}
					if( remove_hidden_hashtags ) {
						shortcode += ' remove_hidden_hashtags="true"';
					}
					if( remove_hidden_urls ) {
						shortcode += ' remove_hidden_urls="true"';
					}



					shortcode += ']' + (get_clean_text()) + '[/tweetthis]';

					editor.selection.setContent(shortcode);
					editor.windowManager.close();
				});



				//	Helper functions
				function tt_preview_string() {
					var text = inputs['text'].val();

					//	Are we supposed to remove anything from the tweet?
					var remove_twits           = inputs['remove_twitter_handles'].prop('checked');
					var remove_url             = inputs['remove_url'].prop('checked');
					var remove_hidden_hashtags = inputs['remove_hidden_hashtags'].prop('checked');
					var remove_hidden_urls     = inputs['remove_hidden_urls'].prop('checked');

					//	Was Twitter handles, default hashtags, or the URL overriden?
					//	If so, we want those.  If not, we want the defaults.
					var twits = default_twitter_handles;
					var hashtags = default_hidden_hashtags;
					var hidden_urls = default_hidden_urls;
					var url = post_url;

					if( get_clean_twitter_handles() || remove_twits ) {
						twits = get_clean_twitter_handles();
					}
					if( get_clean_url() || remove_url ) {
						url = get_clean_url();
					}
					if( get_clean_hidden_hashtags() || remove_hidden_hashtags ) {
						hashtags = get_clean_hidden_hashtags();
					}
					if( get_clean_hidden_urls() || remove_hidden_urls ) {
						hidden_urls = get_clean_hidden_urls();
					}

					var retval = text;
					if(hashtags) {
						retval += ' ' + hashtags;
					}					
					if ( hidden_urls ) {
						retval += ' ' + hidden_urls;
					}
					if ( url ) {
						retval += ' ' + url;
					}
					if (twits) {
						retval +=' via ' + twits;
					}

					return retval;
				}
				function tt_truncate_preview(str) {
					preview.val(preview.val().substr(0,140));	//	First 140 characters
				}
				function get_clean_text() {
					return inputs['text'].val();
				}
				function get_clean_url() {
					if(inputs['remove_url'].prop('checked')) {
						return "";
					}

					return encodeURI( $.trim(inputs['url'].val()) ).
						replace(/"/g, '').	//	remove double quotes
						replace(/'/g, '');	//	remove single quotes;
				}
				function get_clean_twitter_handles() {
					if(inputs['remove_twitter_handles'].prop('checked')) {
						return "";
					}

					return $.trim(inputs['twitter_handles'].val()).
						replace(/"/g, '').	//	remove double quotes
						replace(/'/g, '');	//	remove single quotes
				}
				function get_clean_hidden_hashtags(for_output) {					
					if(inputs['remove_hidden_hashtags'].prop('checked')) {
						return "";
					}

					//	Do we have any override?
					if( $.trim(inputs['hidden_hashtags'].val()) ) {
						var cont = inputs['hidden_hashtags'].val();
					}
					//	Do we have any defaults? If so, and this isn't for output, return them.
					else if( !for_output && $.trim(default_hidden_hashtags) ) {
						var cont = default_hidden_hashtags;
					}
					//	Nothing
					else {
						var cont = '';
					}

					return $.trim(cont).
						replace(/"/g, '').	//	remove double quotes
						replace(/'/g, '');	//	remove single quotes;
				}
				function get_clean_hidden_urls(for_output) {
					if(inputs['remove_hidden_urls'].prop('checked')) {
						return "";
					}

					//	Do we have any override?
					if( $.trim(inputs['hidden_urls'].val()) ) {
						var cont = inputs['hidden_urls'].val();
					}
					//	Do we have any defaults?  If so, and this isn't for output, return them.
					else if( !for_output && $.trim(default_hidden_urls) ) {
						var cont = default_hidden_urls;
					}
					//	Nothing
					else {
						var cont = '';
					}

					return encodeURI( $.trim(cont) ).
						replace(/"/g, '').	//	remove double quotes
						replace(/'/g, '');	//	remove single quotes;
				}
				function get_tinymce_params() {
					//	Get the args... Most of the time, we can use TinyMCE's top
					//	but sometimes it errors out.  When it does, try parent instead.
					var args = null;
					try {
						var args = top.tinymce.activeEditor.windowManager.getParams();
						return args;
					} catch (e) {
						console.log("Tweet This :: Error getting parameters passed to dialog with 'var args = top.tinymce.activeEditor.windowManager.getParams();'.  Trying parent instead of top.");						
					}

					try {
						var args = parent.tinymce.activeEditor.windowManager.getParams();
						console.log("Tweet This :: Successfully obtained parameters using 'var args = parent.tinymce.activeEditor.windowManager.getParams();'.");
						return args;
					} catch (e) {
						console.log("Tweet This :: Error getting parameters passed to dialog with 'var args = parent.tinymce.activeEditor.windowManager.getParams();'.  Switching to brute force method.");
					}

					//	Oh FFS. This is bullcrap. THIS ISN'T SUPPOSED TO HAPPEN. This is the documented
					//	way to extract arguments from a TinyMCE dialog window.  And yet, it happens
					//	more often than I can fathom.  I HATE TINYMCE!

					//	Well, let's brute force this thing. 
					try {
						var args = parent.parent.tinymce.activeEditor.windowManager.getParams();	//	Two deep iframe
						console.log("Tweet This :: Successfully obtained parameters using 'var args = parent.parent.tinymce.activeEditor.windowManager.getParams();'.");
						return args;
					} catch(e) {
						console.log("Tweet This :: Error getting parameters passed to dialog with 'var args = parent.parent.tinymce.activeEditor.windowManager.getParams();'  Trying brute force method #2")
					}
					try {
						var args = parent.parent.parent.tinymce.activeEditor.windowManager.getParams(); //	Three deep iframe
						console.log("Tweet This :: Successfully obtained parameters using 'var args = parent.parent.parent.tinymce.activeEditor.windowManager.getParams();'.");
						return args;
					} catch(e) {
						console.log("Tweet This :: Error getting parameters passed to dialog with 'var args = parent.parent.parent.tinymce.activeEditor.windowManager.getParams();'  Trying brute force method #3")
					}

					//	Okay, another brute force method... the arguments object was written elsewhere for just this occasion.
					try {
						var args = window.parent.tweetthis_tinymce_args;
						console.log("Tweet This :: Successfully obtained parameters using 'var args = window.parent.tweetthis_tinymce_args;'.");
						return args;
					} catch (e) {
						console.log("Tweet This :: Error getting parameters passed to dialog with 'var args = window.parent.tweetthis_tinymce_args;'.  Trying brute force method #4.")
					}

					try {
						var args = window.parent.parent.tweetthis_tinymce_args;
						console.log("Tweet This :: Successfully obtained parameters using 'var args = window.parent.parent.tweetthis_tinymce_args;'.");
						return args;
					} catch (e) {
						console.log("Tweet This :: Error getting parameters passed to dialog with 'var args = window.parent.parent.tweetthis_tinymce_args;'.  Trying brute force method #5.")
					}

					try {
						var args = window.parent.parent.parent.tweetthis_tinymce_args;
						console.log("Tweet This :: Successfully obtained parameters using 'var args = window.parent.parent.parent.tweetthis_tinymce_args;'.");
						return args;
					} catch (e) {
						console.log("Tweet This :: Error getting parameters passed to dialog with 'var args = window.parent.parent.parent.tweetthis_tinymce_args;'.  Trying brute force method #6.")
					}

					try {
						var args = window.top.tweetthis_tinymce_args;
						console.log("Tweet This :: Successfully obtained parameters using 'var args = window.top.tweetthis_tinymce_args;'.");
						return args;
					} catch (e) {
						console.log("Tweet This :: Error getting parameters passed to dialog with 'var args = window.top.tweetthis_tinymce_args;'")						
					}


					//	OMFG. I can't access anything?!?!?!?  Well, let's alert the user, and then die.
					console.log("Tweet This :: Can not access the dialog window's passed arguments.  Dialog can not function without this data.");


					//	Answer contextual questions
					var dbginfo = "Tweet This Error:  Couldn't find TinyMCE arguments/parameters.\n================================\n\n";

					dbginfo += "User Agent\n--------------------------\n";
					dbginfo += navigator.userAgent;

					dbginfo += "\n\nContextual Information\n--------------------------\n--------------------------\n";
					
					try {
						dbginfo += "Is this a single or nested iframe?  ";
						window.parent != window.top ? dbginfo += "Nested" : dbginfo += "Single";
						dbginfo += "\n";
					} catch(e) {}

					//	Top
					try {
						dbginfo += "Can we access 'top'?  ";
						top ? dbginfo += "Yes" : dbginfo += "No";
						dbginfo += "\n";
					} catch(e) {
						dbginfo += "Can we access 'top'?  No. JavaScript exception was thrown: " + e.message;
					}

					try {
						dbginfo += "Can we access 'top.tinymce'?  ";
						top.tinymce ? dbginfo += "Yes" : dbginfo += "No";
						dbginfo += "\n";
					} catch(e) {
						dbginfo += "Can we access 'top.tinymce'?  No. JavaScript exception was thrown: " + e.message;
					}

					try {
						dbginfo += "Can we access 'top.tinymce.activeEditor'?  ";
						top.tinymce.activeEditor ? dbginfo += "Yes" : dbginfo += "No";
						dbginfo += "\n";
					} catch(e) {
						dbginfo += "Can we access 'top.tinymce.activeEditor'?  No. JavaScript exception was thrown: " + e.message;
					}

					try {
						dbginfo += "Can we access 'top.tinymce.activeEditor.windowManager'?  ";
						top.tinymce.activeEditor.windowManager ? dbginfo += "Yes" : dbginfo += "No";
						dbginfo += "\n";
					} catch(e) {
						dbginfo += "Can we access 'top.tinymce.activeEditor.windowManager'?  No. JavaScript exception was thrown: " + e.message;
					}

					//	Parent
					try {
						dbginfo += "\nCan we access 'parent'?  ";
						parent ? dbginfo += "Yes" : dbginfo += "No";
						dbginfo += "\n";
					} catch(e) {
						dbginfo += "Can we access 'parent'?  No. JavaScript exception was thrown: " + e.message;
					}

					try {
						dbginfo += "Can we access 'parent.tinymce'?  ";
						parent.tinymce ? dbginfo += "Yes" : dbginfo += "No";
						dbginfo += "\n";
					} catch(e) {
						dbginfo += "Can we access 'parent.tinymce'?  No. JavaScript exception was thrown: " + e.message;
					}

					try {
						dbginfo += "Can we access 'parent.tinymce.activeEditor'?  ";
						parent.tinymce.activeEditor ? dbginfo += "Yes" : dbginfo += "No";
						dbginfo += "\n";
					} catch(e) {
						dbginfo += "Can we access 'parent.tinymce.activeEditor'?  No. JavaScript exception was thrown: " + e.message;
					}

					try {
						dbginfo += "Can we access 'parent.tinymce.activeEditor.windowManager'?  ";
						parent.tinymce.activeEditor.windowManager ? dbginfo += "Yes" : dbginfo += "No";
						dbginfo += "\n";
					} catch(e) {
						dbginfo += "Can we access 'parent.tinymce.activeEditor.windowManager'?  No. JavaScript exception was thrown: " + e.message;
					}

					//	parent.parent
					try {
						dbginfo += "\nCan we access 'parent.parent'?  ";
						parent.parent ? dbginfo += "Yes" : dbginfo += "No";
						dbginfo += "\n";
					} catch(e) {
						dbginfo += "Can we access 'parent.parent'?  No. JavaScript exception was thrown: " + e.message;
					}

					try {
						dbginfo += "Can we access 'parent.parent.tinymce'?  ";
						parent.parent.tinymce ? dbginfo += "Yes" : dbginfo += "No";
						dbginfo += "\n";
					} catch(e) {
						dbginfo += "Can we access 'parent.parent.tinymce'?  No. JavaScript exception was thrown: " + e.message;
					}

					try {
						dbginfo += "Can we access 'parent.parent.tinymce.activeEditor'?  ";
						parent.parent.tinymce.activeEditor ? dbginfo += "Yes" : dbginfo += "No";
						dbginfo += "\n";
					} catch(e) {
						dbginfo += "Can we access 'parent.parent.tinymce.activeEditor'?  No. JavaScript exception was thrown: " + e.message;
					}

					try {
						dbginfo += "Can we access 'parent.parent.tinymce.activeEditor.windowManager'?  ";
						parent.parent.tinymce.activeEditor.windowManager ? dbginfo += "Yes" : dbginfo += "No";
						dbginfo += "\n";
					} catch(e) {
						dbginfo += "Can we access 'parent.parent.tinymce.activeEditor.windowManager'?  No. JavaScript exception was thrown: " + e.message;
					}







					//	Var Dump the top level body's HTML
					dbginfo += "\n\nwindow.top.document.body HTML\n--------------------------\n--------------------------\n";
					try {
						dbginfo += window.top.document.body.innerHTML;
					} catch(e) {
						dbginfo += "Couldn't access the top frame's innerHTML.  JavaScript exception was thrown: " + e.message;
					}





					var message = "<div style=\"font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif\"><h2>Lucky You!  You've Found an Unrecoverable Error.</h2>";
					message += "<p>You have just stumbled upon a very rare WordPress editor bug. I have been unable to locate the root cause, but, with your help, I can probably work around it.</p>";
					message += "<p>Here's the problem:  Your WordPress editor is not providing data to this shortcode creator <a href='http://www.tinymce.com/wiki.php/Tutorials:Creating_custom_dialogs' target='_blank'>like it is supposed to</a>.  This has happened to a few other plugin users, but the circumstances are slightly different in each case, so I can only react when it occurs, not prevent it.</p>";
					
					message += "<p>Working around this instance of the problem will require a little bit of contextual information (automatically gathered below). Please send me, Tweet This' developer, an <strong>email</strong>, and copy and paste the <strong>data in the text box below</strong> into your message. You can find a contact form for sending an email on <a href='http://tweetthis.jtmorris.net/contact/' target='_blank'>the plugin's website</a>.</p>";
					message += "<p>I'm very sorry for the trouble.  As I said, this is a very rare and unpredictable WordPress problem.</p>";
					message += "<textarea id='tt-dbginfo' style='height: 225px; font-size: 10px;'></textarea></div>";
					
					document.body.innerHTML = message;
									

					//	Insert debug info
					var dbgbox = document.getElementById('tt-dbginfo');					
					dbgbox.value = dbginfo;

					//	Highlight text on focus
					dbgbox.onfocus = function() {
						dbgbox.select();

						dbgbox.onmouseup = function() {
							//	Prevent further mouseup intervention
							dbgbox.onmouseup = null;
							return false;
						};
					}

					return null;
				}
			}());
		</script>
	</body>
</html>
